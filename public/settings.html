<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© - Ù…Ø¯Ø±Ø³Ø© Ø§Ø¨Ù† Ø¯Ø±ÙŠØ¯</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a472a; --accent: #d4af37; --dark: #0a0a0a;
            --success: #27ae60; --danger: #c0392b; --info: #2980b9;
            --card-bg: #1e1e1e;
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; transition: all 0.2s ease; }
        body { background: #121212; color: white; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        .admin-header { height: 8vh; background: var(--primary); border-bottom: 3px solid var(--accent); display: flex; align-items: center; justify-content: center; z-index: 100; gap: 15px; }
        .main-layout { display: grid; grid-template-columns: 380px 1fr; gap: 20px; padding: 20px; height: 92vh; }

        .sidebar { display: flex; flex-direction: column; gap: 15px; overflow-y: auto; padding-right: 5px; }
        .control-card { background: var(--card-bg); border-radius: 15px; padding: 18px; border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .section-title { color: var(--accent); font-size: 1.1rem; margin-bottom: 15px; border-bottom: 2px solid #333; padding-bottom: 8px; font-weight: 900; display: flex; align-items: center; gap: 10px; }

        /* Scores & Turn Indicator */
        .score-box { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .team-score { background: #252525; padding: 15px; border-radius: 12px; text-align: center; position: relative; border-bottom: 4px solid transparent; }
        .turn-dot { position: absolute; top: 10px; right: 10px; width: 14px; height: 14px; background: var(--success); border-radius: 50%; display: none; box-shadow: 0 0 15px var(--success); animation: blink 1s infinite; }
        .is-turn .turn-dot { display: block; }
        .score-val { font-size: 2.5rem; font-weight: 900; color: var(--accent); line-height: 1; margin: 10px 0; }
        .adj-btn { width: 45%; padding: 8px; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; background: #444; color: white; }
        .adj-btn:hover { background: #666; }

        /* Setup Team Section */
        .team-setup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .logo-upload-box { position: relative; width: 80px; height: 80px; background: #333; border-radius: 50%; overflow: hidden; border: 2px dashed var(--accent); cursor: pointer; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; }
        .logo-upload-box img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .logo-upload-box span { font-size: 0.7rem; text-align: center; color: #888; pointer-events: none; padding: 5px; }

        /* Question Center */
        .center-panel { display: flex; flex-direction: column; gap: 20px; }
        .q-preview-box { background: #000; border-radius: 20px; padding: 25px; border-right: 8px solid var(--info); flex-grow: 1; display: flex; flex-direction: column; position: relative; }
        .q-meta { color: var(--accent); font-size: 1.1rem; margin-bottom: 10px; font-weight: bold; background: rgba(212, 175, 55, 0.1); padding: 5px 15px; border-radius: 50px; display: inline-block; width: fit-content; }
        .q-text { font-size: 2rem; font-weight: 900; line-height: 1.4; color: #fff; margin-top: 10px; }
        .q-ans-hint { margin-top: auto; padding: 15px; background: rgba(39, 174, 96, 0.15); border-radius: 10px; color: var(--success); font-weight: 900; display: none; border: 1px dashed var(--success); font-size: 1.2rem; }

        .live-status { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .status-pill { padding: 15px; border-radius: 12px; background: #1a1a1a; border: 1px solid #333; text-align: center; font-weight: bold; }
        .has-selected { background: rgba(39, 174, 96, 0.25); border-color: var(--success); color: var(--success); transform: scale(1.02); }

        .btn { padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 1rem; }
        .btn-next { background: var(--info); color: white; width: 100%; font-size: 1.3rem; height: 60px; box-shadow: 0 5px 15px rgba(41, 128, 185, 0.4); }
        .btn-round { background: #2a2a2a; color: #aaa; border: 1px solid #444; }
        .btn-round.active { background: var(--accent); color: #000; font-weight: 900; }

        #alert-banner { position: fixed; top: 12vh; left: 50%; transform: translateX(-50%); background: var(--danger); color: white; padding: 15px 40px; border-radius: 12px; font-weight: 900; z-index: 1000; display: none; box-shadow: 0 10px 40px rgba(0,0,0,0.8); border: 3px solid white; animation: slideDown 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28); font-size: 1.4rem; }

        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        @keyframes slideDown { from { transform: translate(-50%, -100px); } to { transform: translate(-50%, 0); } }

        input[type="text"] { width: 100%; background: #2d2d2d; border: 1px solid #444; padding: 10px; color: white; border-radius: 8px; margin-bottom: 5px; text-align: center; }
        input[type="text"]:focus { border-color: var(--accent); outline: none; }
    </style>
</head>
<body>

    <div id="alert-banner">ğŸ”” Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ø®ØªØ§Ø± Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹ÙˆØ¨Ø©!</div>

    <header class="admin-header">
        <span style="font-size: 1.5rem;">âš™ï¸</span>
        <h2 style="margin:0">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ù…Ø¯Ø±Ø³Ø© Ø§Ø¨Ù† Ø¯Ø±ÙŠØ¯</h2>
    </header>

    <main class="main-layout">
        <aside class="sidebar">
            <div class="control-card">
                <div class="section-title">ğŸ“Š Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù†Ù‚Ø§Ø·</div>
                <div class="score-box">
                    <div class="team-score" id="admin-box-group1">
                        <div class="turn-dot"></div>
                        <div id="disp-n1" style="font-weight:900; color:#888;">Ø§Ù„ÙØ±ÙŠÙ‚ 1</div>
                        <div id="admin-s1" class="score-val">0</div>
                        <div style="display:flex; gap:5px; justify-content:center;">
                            <button class="adj-btn" onclick="adjustScore('group1', 1)">+1</button>
                            <button class="adj-btn" onclick="adjustScore('group1', -1)">-1</button>
                        </div>
                    </div>
                    <div class="team-score" id="admin-box-group2">
                        <div class="turn-dot"></div>
                        <div id="disp-n2" style="font-weight:900; color:#888;">Ø§Ù„ÙØ±ÙŠÙ‚ 2</div>
                        <div id="admin-s2" class="score-val">0</div>
                        <div style="display:flex; gap:5px; justify-content:center;">
                            <button class="adj-btn" onclick="adjustScore('group2', 1)">+1</button>
                            <button class="adj-btn" onclick="adjustScore('group2', -1)">-1</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="control-card">
                <div class="section-title">ğŸ® Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø¬ÙˆÙ„Ø§Øª</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <button class="btn btn-round" id="r1" onclick="setRound(1)">1. Ø¬ÙˆÙ„Ø© Ø§Ù„ØªÙ†Ø§ÙˆØ¨</button>
                    <button class="btn btn-round" id="r2" onclick="setRound(2)">2. Ø¬ÙˆÙ„Ø© Ø§Ù„Ø³Ø±Ø¹Ø©</button>
                    <button class="btn btn-round" id="r3" onclick="setRound(3)">3. Ø¬ÙˆÙ„Ø© Ø§Ù„ØªØ­Ø¯ÙŠ</button>
                    <button class="btn" style="background:var(--danger); color:white; font-weight:900;" onclick="endGame()">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© ğŸ</button>
                </div>
            </div>

            <div class="control-card">
                <div class="section-title">ğŸ“ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙØ±Ù‚ ÙˆØ§Ù„Ù…Ù„ÙØ§Øª</div>
                <div class="team-setup-grid">
                    <div>
                        <div class="logo-upload-box" onclick="document.getElementById('l1').click()">
                            <span>Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ Ø´Ø¹Ø§Ø± 1</span>
                            <img id="img1">
                        </div>
                        <input type="file" id="l1" hidden onchange="handleLogo(this, 'img1')" accept="image/*">
                        <input type="text" id="t1-name" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚ 1">
                    </div>
                    <div>
                        <div class="logo-upload-box" onclick="document.getElementById('l2').click()">
                            <span>Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ Ø´Ø¹Ø§Ø± 2</span>
                            <img id="img2">
                        </div>
                        <input type="file" id="l2" hidden onchange="handleLogo(this, 'img2')" accept="image/*">
                        <input type="text" id="t2-name" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚ 2">
                    </div>
                </div>
                <label style="font-size: 0.8rem; color: var(--accent); margin-bottom: 5px; display: block;">ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (JSON):</label>
                <input type="file" id="jsonLoader" accept=".json" style="margin-bottom:15px; font-size: 0.8rem; width:100%; color:#aaa;">
                <button class="btn" style="background:var(--accent); color:black; width:100%; font-weight:900;" onclick="initSystem()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¨Ø¯Ø¡ ğŸš€</button>
                <button class="btn" style="background:#333; color:#f44; width:100%; margin-top:8px; font-size:0.8rem;" onclick="resetGame()">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒØ§Ù…Ù„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
            </div>
        </aside>

        <section class="center-panel">
            <div class="q-preview-box">
                <div class="q-meta" id="q-meta-info">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ø±Ø³Ø§Ù„ Ø³Ø¤Ø§Ù„...</div>
                <div class="q-text" id="active-q-text">ÙŠØ±Ø¬Ù‰ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø«Ù… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ" Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©.</div>
                <div id="active-q-ans" class="q-ans-hint"></div>
                
                <div class="live-status">
                    <div id="stat-g1" class="status-pill">ÙØ±ÙŠÙ‚ 1: Ù„Ù… ÙŠØ®ØªØ±</div>
                    <div id="stat-g2" class="status-pill">ÙØ±ÙŠÙ‚ 2: Ù„Ù… ÙŠØ®ØªØ±</div>
                </div>
            </div>

            <div class="control-card">
                <div style="display:grid; grid-template-columns: 2fr 1fr 1fr; gap:15px;">
                    <button class="btn btn-next" onclick="sendNext()">Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ â¡ï¸</button>
                    <button class="btn" style="background:var(--success); color:white" onclick="socket.emit('revealAnswer')">ÙƒØ´Ù Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© âœ…</button>
                    <button class="btn" style="background:var(--danger); color:white" onclick="socket.emit('resetBuzzer')">ØªØµÙÙŠØ± Ø§Ù„Ø¨Ø§Ø²Ø± ğŸš¨</button>
                </div>
            </div>
        </section>
    </main>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let db = null;
        let counters = { r1: 0, r2: 0, r3: 0 };
        let currentRound = 1;

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ± ÙˆØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ù„Ù€ Base64
        function handleLogo(input, imgId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.getElementById(imgId);
                    img.src = e.target.result;
                    img.style.display = "block";
                    img.parentElement.querySelector('span').style.display = "none";
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
        document.getElementById('jsonLoader').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (ev) => { 
                try {
                    db = JSON.parse(ev.target.result); 
                    alert("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!"); 
                } catch(err) { alert("âŒ Ø®Ø·Ø£: ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© ØªÙ†Ø³ÙŠÙ‚ Ù…Ù„Ù JSON"); }
            };
            reader.readAsText(e.target.files[0]);
        };

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ù„Ø³ÙŠØ±ÙØ±
        function initSystem() {
            const data = {
                t1: document.getElementById('t1-name').value || "Ø§Ù„ÙØ±ÙŠÙ‚ 1",
                t2: document.getElementById('t2-name').value || "Ø§Ù„ÙØ±ÙŠÙ‚ 2",
                logo1: document.getElementById('img1').src.startsWith('data') ? document.getElementById('img1').src : null,
                logo2: document.getElementById('img2').src.startsWith('data') ? document.getElementById('img2').src : null
            };
            socket.emit('setupGame', data);
            alert("ğŸš€ ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ§Ù„Ø´Ø¹Ø§Ø±Ø§Øª.");
        }

        function setRound(r) {
            currentRound = r;
            socket.emit('changeRound', r);
            document.querySelectorAll('.btn-round').forEach(b => b.classList.remove('active'));
            document.getElementById('r'+r).classList.add('active');
            document.getElementById('alert-banner').style.display = 'none';
        }

        function sendNext() {
            if(!db) return alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹");
            const qSet = db['round' + currentRound];
            if(!qSet || counters['r'+currentRound] >= qSet.length) return alert("ğŸ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¬ÙˆÙ„Ø©");
            
            const question = qSet[counters['r'+currentRound]];
            socket.emit('pushQuestion', question);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù„Ù„Ù…Ø¹Ù„Ù…
            document.getElementById('active-q-text').innerText = question.question;
            const ansBox = document.getElementById('active-q-ans');
            ansBox.innerText = "ğŸ’¡ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ: " + question.options[question.answer];
            ansBox.style.display = "block";
            document.getElementById('q-meta-info').innerText = `Ø¬ÙˆÙ„Ø© ${currentRound} | Ø³Ø¤Ø§Ù„ ${counters['r'+currentRound] + 1}`;
            
            counters['r'+currentRound]++;
            document.getElementById('alert-banner').style.display = 'none';
        }

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø­ÙŠØ©
        socket.on('gameStateUpdate', (state) => {
            document.getElementById('admin-s1').innerText = state.teams.group1.score;
            document.getElementById('admin-s2').innerText = state.teams.group2.score;
            document.getElementById('disp-n1').innerText = state.teams.group1.name;
            document.getElementById('disp-n2').innerText = state.teams.group2.name;

            // ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± Ø§Ù„Ø¯ÙˆØ±
            document.getElementById('admin-box-group1').classList.toggle('is-turn', state.currentTurn === 'group1');
            document.getElementById('admin-box-group2').classList.toggle('is-turn', state.currentTurn === 'group2');
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„Ø­Ø¸ÙŠØ©
            updateStatus('stat-g1', state.selections.group1, state.teams.group1.name);
            updateStatus('stat-g2', state.selections.group2, state.teams.group2.name);
        });

        function updateStatus(id, selection, name) {
            const el = document.getElementById(id);
            if(selection !== null) {
                el.innerText = `${name}: Ø§Ø®ØªØ§Ø± Ø§Ù„Ø¨Ø¯ÙŠÙ„ Ø±Ù‚Ù… (${selection + 1})`;
                el.classList.add('has-selected');
            } else {
                el.innerText = `${name}: Ù„Ù… ÙŠØ®ØªØ± Ø¨Ø¹Ø¯`;
                el.classList.remove('has-selected');
            }
        }

        // ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªÙˆÙ‰ ÙÙŠ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©
        socket.on('levelSelectedAlert', (data) => {
            const banner = document.getElementById('alert-banner');
            const levelsArr = { 'normal': 'Ø¹Ø§Ø¯ÙŠ (2Ù†)', 'hard': 'ØµØ¹Ø¨ (5Ù†)', 'super': 'Ø®Ø§Ø±Ù‚ (10Ù†)' };
            banner.innerText = `ğŸ”” Ø§Ù„ÙØ±ÙŠÙ‚ [${data.teamName}] Ø§Ø®ØªØ§Ø± Ù…Ø³ØªÙˆÙ‰: ${levelsArr[data.level] || data.level}`;
            banner.style.display = 'block';
        });

        function adjustScore(team, val) { socket.emit('manualScore', { team, val }); }
        
        function resetGame() { if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØµÙÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ")) socket.emit('resetFull'); }
        
        function endGame() { if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©ØŸ")) socket.emit('endGame'); }
    </script>
</body>
</html>