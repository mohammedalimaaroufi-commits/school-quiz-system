<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ø¬Ù‡Ø§Ø² Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ Pro - Ù…Ø¯Ø±Ø³Ø© Ø§Ø¨Ù† Ø¯Ø±ÙŠØ¯</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00f2fe; --accent: #ffd700;
            --danger: #ff4757; --success: #2ed573;
            --card-bg: rgba(255, 255, 255, 0.08); 
            --border: rgba(255, 255, 255, 0.15);
            --bg-wait: radial-gradient(circle at center, #471a1a 0%, #140505 100%);
            --bg-active: radial-gradient(circle at center, #1a472a 0%, #05140a 100%);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { 
            height: 100vh; margin: 0; padding: 0; overflow: hidden;
            background: #050a0a;
            transition: background 0.5s ease;
            color: white; font-family: 'Cairo', sans-serif;
            display: flex; flex-direction: column;
        }

        body.wait-mode { background-image: var(--bg-wait); }
        body.active-mode { background-image: var(--bg-active); }

        .top-bar {
            padding: env(safe-area-inset-top) 20px 15px;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(15px);
            border-bottom: 3px solid var(--accent);
            display: flex; justify-content: space-between; align-items: center;
            z-index: 1000;
        }

        .timer-box {
            width: 60px; height: 60px; border-radius: 12px;
            border: 3px solid var(--accent); display: flex;
            align-items: center; justify-content: center;
            font-size: 1.8rem; font-weight: 900; background: #000;
            color: var(--accent); transition: 0.3s;
        }

        .main-container { 
            flex: 1; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; 
            padding: 20px; width: 100%; position: relative;
        }

        .options-stack { 
            width: 100%; max-width: 500px; display: none; 
            flex-direction: column; gap: 12px; 
        }

        .opt-item {
            background: var(--card-bg); border: 2px solid var(--border);
            padding: 20px; border-radius: 20px; cursor: pointer;
            transition: transform 0.1s, background 0.3s, border-color 0.3s;
            display: flex; align-items: center; justify-content: space-between;
            position: relative; overflow: hidden;
        }

        .opt-item:active { transform: scale(0.98); }
        .opt-text { font-size: 1.3rem; font-weight: 700; flex: 1; text-align: right; }
        
        .opt-letter {
            width: 35px; height: 35px; border-radius: 50%;
            background: rgba(255,255,255,0.1); display: flex;
            align-items: center; justify-content: center;
            font-size: 1.1rem; font-weight: 900; margin-left: 12px;
        }

        .confirm-circle-btn {
            width: 50px; height: 50px; border-radius: 50%;
            background: var(--success); border: 3px solid #fff;
            position: absolute; left: 10px; top: 50%;
            transform: translateY(-50%) scale(0);
            display: flex; align-items: center; justify-content: center;
            z-index: 10; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .opt-item.selected {
            background: rgba(0, 242, 254, 0.12);
            border-color: var(--primary);
        }

        .opt-item.selected .confirm-circle-btn { transform: translateY(-50%) scale(1); }

        .buzzer-btn {
            width: 220px; height: 220px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ff4b2b, #b20000);
            border: 8px solid #fff; font-size: 2.2rem; font-weight: 900; color: white;
            box-shadow: 0 12px 0 #5e0000, 0 25px 50px rgba(0,0,0,0.6);
            cursor: pointer; transition: 0.1s;
        }
        .buzzer-btn:active { transform: translateY(8px); box-shadow: 0 4px 0 #5e0000; }

        .status-card {
            background: var(--card-bg); border-radius: 25px; padding: 30px;
            text-align: center; width: 100%; max-width: 450px;
            border: 1px solid var(--border); backdrop-filter: blur(10px);
        }

        .level-0 { border-color: #27ae60; background: rgba(39, 174, 96, 0.05); }
        .level-1 { border-color: #e67e22; background: rgba(230, 126, 34, 0.05); }
        .level-2 { border-color: #c0392b; background: rgba(192, 57, 43, 0.05); }

    </style>
</head>
<body class="wait-mode"> 
    <div class="top-bar">
        <div id="team-display" style="font-weight: 900; color: var(--accent); font-size: 1.4rem;">Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„...</div>
        <div class="timer-box" id="timer-box">60</div>
    </div>

    <div class="main-container">
        <div id="status-container" class="status-card">
            <div id="status-msg" style="font-size: 1.6rem; font-weight: 700; line-height: 1.4;">Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…...</div>
        </div>

        <div id="buzzer-area" style="display:none;">
            <button class="buzzer-btn" id="main-buzzer">Ø§Ø¶ØºØ· Ø§Ù„Ø¢Ù†!</button>
        </div>

        <div id="options-area" class="options-stack"></div>

        <div id="levels-area" class="options-stack">
            <h2 style="text-align:center; color:var(--accent); margin-bottom: 20px;">Ø§Ø®ØªØ± Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹ÙˆØ¨Ø©</h2>
            <div class="opt-item level-0" onclick="pickLevel('normal')">
                <div class="opt-text">Ù…Ø³ØªÙˆÙ‰ Ø¹Ø§Ø¯ÙŠ (+2)</div>
                <div class="opt-letter">C</div>
            </div>
            <div class="opt-item level-1" onclick="pickLevel('hard')">
                <div class="opt-text">Ù…Ø³ØªÙˆÙ‰ ØµØ¹Ø¨ (+5)</div>
                <div class="opt-letter">B</div>
            </div>
            <div class="opt-item level-2" onclick="pickLevel('super')">
                <div class="opt-text">Ù…Ø³ØªÙˆÙ‰ Ø®Ø§Ø±Ù‚ (+10)</div>
                <div class="opt-letter">A</div>
            </div>
        </div>

        <div id="game-over-view" class="status-card" style="display:none;">
            <h2 style="color:var(--accent); font-size: 2rem;">ğŸ† Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</h2>
            <p>Ø´ÙƒØ±Ø§Ù‹ Ù„Ù…Ø´Ø§Ø±ÙƒØªÙƒÙ….. ØªØ±Ù‚Ø¨ÙˆØ§ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©</p>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const params = new URLSearchParams(window.location.search);
        const myTeam = params.get('team') || 'group1';
        let lastQuestionText = ""; // Ù„ØªØªØ¨Ø¹ ØªØºÙŠÙŠØ± Ø§Ù„Ø³Ø¤Ø§Ù„

        function vibrate(ms = 50) { if (window.navigator.vibrate) window.navigator.vibrate(ms); }

        socket.on('gameStateUpdate', (state) => {
            if (!state) return;

            if(state.teams && state.teams[myTeam]) {
                document.getElementById('team-display').innerText = state.teams[myTeam].name;
            }

            hideAllViews();

            if (state.isGameOver) {
                showView('game-over-view');
                updateTheme(false);
                return;
            }

            const round = state.activeRound;
            let isMyTurnNow = false;

            if (round === 3) {
                isMyTurnNow = (state.currentTurn === myTeam);
                if (isMyTurnNow) {
                    if (state.currentQuestion) {
                        showView('options-area');
                        renderOptions(state);
                    } else if (state.selectedLevel) {
                        showStatus(`ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªÙˆÙ‰ [${state.selectedLevel}]<br>Ø§Ø³ØªØ¹Ø¯ Ù„Ù„Ø³Ø¤Ø§Ù„...`);
                    } else {
                        showView('levels-area');
                    }
                } else {
                    showStatus("Ø§Ù†ØªØ¸Ø± Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ù…Ù†Ø§ÙØ³ Ù„ÙŠØ­Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªÙˆÙ‰.. â³");
                }
            } 
            else if (round === 2) {
                isMyTurnNow = !state.buzzerWinner && (!state.wrongAnswers || !state.wrongAnswers[myTeam]);
                
                if (isMyTurnNow) {
                    showView('buzzer-area');
                } else if (state.buzzerWinner === myTeam) {
                    isMyTurnNow = true;
                    if (state.currentQuestion) {
                        showView('options-area');
                        renderOptions(state);
                    } else {
                        showStatus("Ø£Ø³Ø±Ø¹Øª Ø¨Ø§Ù„Ø¶ØºØ·! Ø§Ø³ØªØ¹Ø¯ Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø©..");
                    }
                } else {
                    const winnerName = state.teams[state.buzzerWinner]?.name || "Ø§Ù„Ù…Ù†Ø§ÙØ³";
                    showStatus(state.wrongAnswers && state.wrongAnswers[myTeam] ? "Ù„Ù„Ø£Ø³Ù! Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø© âŒ" : `ÙØ±ÙŠÙ‚ [${winnerName}] ÙŠØ¬Ø§ÙˆØ¨ Ø§Ù„Ø¢Ù†.. â³`);
                }
            } 
            else {
                isMyTurnNow = (state.currentTurn === myTeam);
                if (isMyTurnNow) {
                    if (state.currentQuestion) {
                        showView('options-area');
                        renderOptions(state);
                    } else {
                        showStatus("Ø¯ÙˆØ±ÙƒÙ… Ø§Ù„Ø¢Ù†! Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³Ø¤Ø§Ù„.. ğŸŒŸ");
                    }
                } else {
                    showStatus("Ø§Ù†ØªØ¸Ø± Ø¯ÙˆØ±ÙƒÙ….. Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¢Ø®Ø± ÙŠØ¬Ø§ÙˆØ¨ â³");
                }
            }

            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø³Ø¤Ø§Ù„ Ø­Ø§Ù„ÙŠØŒ Ù†ØµÙØ± Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø®Ø²Ù†
            if (!state.currentQuestion) {
                lastQuestionText = "";
            }

            updateTheme(isMyTurnNow);
        });

        function updateTheme(isActive) {
            const body = document.body;
            if (isActive) {
                body.classList.remove('wait-mode');
                body.classList.add('active-mode');
            } else {
                body.classList.remove('active-mode');
                body.classList.add('wait-mode');
            }
        }

        function renderOptions(state) {
            const container = document.getElementById('options-area');
            const q = state.currentQuestion;
            if (!q) return;

            // Ø§Ù„Ø¥ØµÙ„Ø§Ø­: Ø¥Ø°Ø§ ØªØºÙŠØ± Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ØŒ Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª ÙÙˆØ±Ø§Ù‹
            if (lastQuestionText !== q.question) {
                lastQuestionText = q.question;
                container.innerHTML = '';
                
                q.options.forEach((opt, idx) => {
                    const div = document.createElement('div');
                    div.className = 'opt-item';
                    div.setAttribute('data-idx', idx);
                    div.innerHTML = `
                        <div class="confirm-circle-btn">âœ…</div>
                        <div class="opt-text">${opt}</div>
                        <div class="opt-letter">${String.fromCharCode(65 + idx)}</div>
                    `;

                    div.onclick = () => {
                        if (state.revealAnswer) return;
                        vibrate(30);
                        container.querySelectorAll('.opt-item').forEach(i => i.classList.remove('selected'));
                        div.classList.add('selected');
                        socket.emit('updateSelection', { teamId: myTeam, answerIdx: idx });
                    };

                    const confirmBtn = div.querySelector('.confirm-circle-btn');
                    confirmBtn.onclick = (e) => {
                        e.stopPropagation();
                        vibrate([100, 50, 100]);
                        socket.emit('submitAnswer', { teamId: myTeam, answerIdx: idx });
                        showStatus("ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©.. Ø¨Ø§Ù„ØªÙˆÙÙŠÙ‚! ğŸš€");
                    };

                    container.appendChild(div);
                });
            }

            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± ÙˆØ§Ù„Ù‚ÙÙ„
            q.options.forEach((_, idx) => {
                const item = container.querySelector(`[data-idx="${idx}"]`);
                if (!item) return;
                
                if (state.selections && state.selections[myTeam] === idx) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
                
                if (state.revealAnswer) {
                    item.style.pointerEvents = 'none';
                    item.style.opacity = '0.7';
                } else {
                    item.style.pointerEvents = 'auto';
                    item.style.opacity = '1';
                }
            });
        }

        function pickLevel(level) {
            vibrate([100, 50, 100]);
            socket.emit('selectLevel', { team: myTeam, level: level });
        }

        function hideAllViews() {
            ['buzzer-area', 'options-area', 'levels-area', 'status-container', 'game-over-view'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
        }

        function showView(id) {
            const el = document.getElementById(id);
            if (el) el.style.display = (id.includes('area')) ? 'flex' : 'block';
        }

        function showStatus(msg) {
            showView('status-container');
            document.getElementById('status-msg').innerHTML = msg;
        }

        document.getElementById('main-buzzer').onclick = () => {
            vibrate(150);
            socket.emit('pressBuzzer', myTeam);
        };

        socket.on('timerUpdate', (t) => {
            const timerEl = document.getElementById('timer-box');
            if (timerEl) {
                timerEl.innerText = t;
                timerEl.style.borderColor = (t <= 5) ? 'var(--danger)' : 'var(--accent)';
                timerEl.style.color = (t <= 5) ? 'var(--danger)' : 'var(--accent)';
            }
        });

        socket.on('buzzerWon', (teamId) => {
            if (teamId === myTeam) vibrate([200, 100, 200]);
        });
    </script>
</body>
</html>